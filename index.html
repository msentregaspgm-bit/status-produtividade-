<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Status da Frota - Souza</title>
  <link rel="manifest" href="manifest.json">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://unpkg.com/leaflet.fullscreen/Control.FullScreen.js"></script>
  <link rel="stylesheet" href="https://unpkg.com/leaflet.fullscreen/Control.FullScreen.css" />
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body { background-color: #fff; font-family: 'Segoe UI', sans-serif; padding: 15px; transition: background-color 0.3s, color 0.3s; }
    body.dark-mode { background-color: #1c1c1c; color: #fff; }
    .logo-container img { width: 160px; border-radius: 10px; }
    #map { height: 450px; border-radius: 15px; margin-top: 20px; }
    .footer { text-align: center; color: #6c757d; margin-top: 20px; font-size: 0.9rem; }
  </style>
</head>
<body>
  <div class="container">
    <div class="logo-container text-center mb-3">
      <img src="logo.png" alt="Logo Souza">
    </div>
    <div class="text-center mb-3 d-flex justify-content-center gap-2">
      <button id="refreshBtn" class="btn btn-success btn-sm">üîÑ Atualizar</button>
      <button id="darkModeBtn" class="btn btn-outline-dark btn-sm">üåô Modo Escuro</button>
      <button id="produtividadeBtn" class="btn btn-outline-success btn-sm">üìä Produtividade</button>
    </div>
    <div id="map"></div>
    <div id="frotaContainer" class="row g-3 mt-2"></div>
    <div class="footer">¬© 2025 Controle de Frota | Souza Transportes</div>
  </div>

  <!-- Modal PRODUTIVIDADE -->
  <div class="modal fade" id="produtividadeModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-fullscreen">
      <div class="modal-content">
        <div class="modal-body" id="tabelasProdutividade">
          <p class="text-secondary">Carregando...</p>
        </div>
      </div>
    </div>
  </div>

<script>
const sheetCSV = "https://docs.google.com/spreadsheets/d/e/2PACX-1vTPPayk88qhh1VviHffMZKaNmicNnoiusxtMRc-pi7bzk0YZzoWnMSysT5fs8IVbqnLSAHir-UuNZpc/pub?gid=165883713&single=true&output=csv";

function parseCSV(text){
  const rows=[],row=[],arr=[];let cur="",inQ=false,tmp=[];
  for(let i=0;i<text.length;i++){
    const c=text[i],n=text[i+1];
    if(c=='"'){if(inQ&&n=='"'){cur+='"';i++;}else inQ=!inQ;}
    else if(c==","&&!inQ){tmp.push(cur);cur="";}
    else if((c=="\n"||c=="\r")&&!inQ){if(c=="\r"&&text[i+1]=="\n")i++;tmp.push(cur);rows.push(tmp);cur="";tmp=[];}
    else cur+=c;
  }
  if(cur||tmp.length){tmp.push(cur);rows.push(tmp);}
  return rows.map(rr=>rr.map(cc=>{let v=cc.trim();if(v.startsWith('"')&&v.endsWith('"'))v=v.slice(1,-1);return v.replace(/""/g,'"');}));
}

function parseNumber(s){if(!s)return 0;return Number(s.replace(/[R$\s"]/g,"").replace(/\./g,"").replace(",",".").trim())||0;}

async function carregarProdutividade(){
  const area=document.getElementById("tabelasProdutividade");
  area.innerHTML="<p class='text-secondary'>Carregando produtividade...</p>";
  try{
    const resp=await fetch(sheetCSV+"&t="+Date.now(),{cache:"no-store"});
    const txt=await resp.text();
    const linhas=parseCSV(txt);
    const cab=linhas.shift();
    const mot=new Set();
    const dados=[];
    linhas.forEach(l=>{if(!l.some(x=>x&&x.trim()!=""))return;const o={};cab.forEach((h,i)=>o[h]=l[i]||"");if(o["MOTORISTA"])mot.add(o["MOTORISTA"]);dados.push(o);});

    area.innerHTML=\`
    <div class='d-flex justify-content-between align-items-center mb-3'>
      <button id='voltarTelaInicial' class='btn btn-outline-secondary btn-sm'>‚¨ÖÔ∏è Voltar</button>
      <h5 class='text-success fw-bold m-0'>Painel de Produtividade</h5>
      <button id='atualizarProdutividade' class='btn btn-success btn-sm'>üîÑ Atualizar</button>
    </div>
    <div class='text-start mb-3'>
      <label class='form-label fw-semibold small text-success'>Filtrar por Motorista:</label>
      <select id='filtroMotorista' class='form-select form-select-sm' style='max-width:300px;display:inline-block;'>
        <option value=''>Todos</option>\${Array.from(mot).map(m=>\`<option value='\${m}'>\${m}</option>\`).join("")}
      </select>
    </div>
    <canvas id='graficoProdutividade' height='120' class='mb-4'></canvas>
    <div id='tabelaProdutividade'></div>\`;

    async function renderTabela(f=""){
      const filt=f?dados.filter(d=>d["MOTORISTA"]===f):dados;
      let html="<div class='table-responsive'><table class='table table-striped table-bordered table-sm'><thead class='table-success'><tr>";
      cab.forEach(c=>html+=\`<th>\${c}</th>\`);html+="</tr></thead><tbody>";
      let totF=0,totC=0;
      filt.forEach(l=>{
        html+="<tr>";
        cab.forEach(c=>{
          let v=l[c]||"";
          if(c.toLowerCase().includes("frete"))totF+=parseNumber(v);
          if(c.toLowerCase().includes("comiss√£o"))totC+=parseNumber(v);
          html+=\`<td>\${v}</td>\`;
        });
        html+="</tr>";
      });
      html+=\`</tbody><tfoot class='table-light'><tr><th colspan='\${cab.length-2}' class='text-end'>Totais:</th><th>R$ \${totF.toLocaleString("pt-BR",{minimumFractionDigits:2})}</th><th>R$ \${totC.toLocaleString("pt-BR",{minimumFractionDigits:2})}</th></tr></tfoot></table></div>\`;
      document.getElementById("tabelaProdutividade").innerHTML=html;

      const ctx=document.getElementById("graficoProdutividade");
      const dadosG={};
      filt.forEach(l=>{
        const m=l["MOTORISTA"]||"Sem nome";
        const f=parseNumber(l["FATURAMENTO FRETE"])||0;
        const c=parseNumber(l["COMISS√ÉO (12%)"])||0;
        if(!dadosG[m])dadosG[m]={f:0,c:0};
        dadosG[m].f+=f;dadosG[m].c+=c;
      });
      const labels=Object.keys(dadosG);
      const valF=labels.map(k=>dadosG[k].f);
      const valC=labels.map(k=>dadosG[k].c);

      if(window.produtividadeChart)window.produtividadeChart.destroy();
      window.produtividadeChart=new Chart(ctx,{type:"bar",data:{labels:labels,datasets:[{label:"Faturamento Frete (R$)",data:valF,backgroundColor:"rgba(25,135,84,0.7)",borderColor:"#198754",borderWidth:1},{label:"Comiss√£o (R$)",data:valC,backgroundColor:"rgba(255,193,7,0.7)",borderColor:"#ffc107",borderWidth:1}]},options:{responsive:true,plugins:{legend:{display:true,position:"top"},title:{display:true,text:"Frete x Comiss√£o por Motorista",font:{size:16}}},scales:{y:{beginAtZero:true}}}});

      document.getElementById("filtroMotorista").addEventListener("change",e=>renderTabela(e.target.value));
      document.getElementById("voltarTelaInicial").addEventListener("click",()=>{bootstrap.Modal.getInstance(document.getElementById("produtividadeModal")).hide();});
      document.getElementById("atualizarProdutividade").addEventListener("click",carregarProdutividade);
    }
    renderTabela();
  }catch(e){area.innerHTML="<p class='text-danger'>Erro ao carregar</p>";}
}

document.getElementById("produtividadeBtn").addEventListener("click",()=>{const modal=new bootstrap.Modal(document.getElementById("produtividadeModal"));modal.show();carregarProdutividade();});
</script>
</body>
</html>
