<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Souza Transportes</title>

<!-- PWA manifest -->
<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#2e7d32">

<!-- Bootstrap, Leaflet, Chart.js -->
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" defer></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js" defer></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2" defer></script>

<style>
  /* mantÃ©m o estilo original do seu dashboard */
  :root{ --verde-souza:#2e7d32; --bg:#ffffff; --card-bg:#ffffff; --muted:#6c757d; }
  body{ background:var(--bg); color:#222; font-family:Inter, "Segoe UI", Roboto, Arial, sans-serif; padding:12px; transition:background .25s,color .25s; }
  body.dark-mode{ background:#111; color:#eee; }
  header{ display:flex; align-items:center; justify-content:space-between; gap:8px; flex-wrap:wrap; margin-bottom:8px; }
  .logo-left{ width:56px; height:auto; border-radius:6px; }
  .title-wrap{ text-align:center; flex:1; min-width:180px; }
  h1{ margin:0; color:var(--verde-souza); font-weight:700; font-size:20px; }
  .app-legend{ text-align:center; font-size:0.95rem; color:var(--muted); margin-top:4px; }
  .btn-icon{ border-radius:50%; width:40px; height:40px; display:flex; align-items:center; justify-content:center; }
  .topbar{ display:flex; gap:8px; justify-content:center; align-items:center; flex-wrap:wrap; margin:12px 0; }
  .nav-btn{ width:44px; height:44px; padding:0; border-radius:8px; display:flex; align-items:center; justify-content:center; }
  .nav-btn.active{ box-shadow: inset 0 3px 6px rgba(0,0,0,0.12); }
  .card-kpi{ border-radius:10px; background:var(--card-bg); box-shadow:0 3px 10px rgba(0,0,0,0.06); padding:12px; }
  .kpi-label{ font-size:0.85rem; color:var(--muted); }
  .kpi-value{ font-weight:700; color:var(--verde-souza); font-size:1.3rem; }
  #map{ height:520px; border-radius:12px; margin-bottom:12px; position:relative; }
  .chart-card{ padding:12px; border-radius:10px; background:var(--card-bg); box-shadow:0 3px 10px rgba(0,0,0,0.06); }
  canvas{ max-height:300px !important; height:300px !important; width:100% !important; }
  .section{ display:none; }
  .section.active{ display:block; }
  .footer{ text-align:center; color:var(--muted); margin-top:14px; font-size:0.85rem; }
  @media(max-width:768px){ #map{ height:420px; } h1{ font-size:18px; } canvas{ max-height:260px !important; height:260px !important; } }
  .truck-label { display:inline-flex; align-items:center; gap:6px; padding:4px 8px; border-radius:8px; font-size:12px; font-weight:600; background:rgba(255,255,255,0.92); box-shadow:0 1px 3px rgba(0,0,0,0.18); white-space:nowrap; }
  .truck-label .truck-emoji { margin-right:4px; }
  .leaflet-control.custom-fullscreen a { background:#fff; padding:6px; border-radius:6px; display:inline-block; box-shadow:0 1px 3px rgba(0,0,0,0.2); }
  .loading-overlay { position:fixed; left:0; right:0; top:0; bottom:0; display:flex; align-items:center; justify-content:center; background:rgba(255,255,255,0.6); z-index:1200; font-size:1.1rem; color:#333; }
  body.dark-mode .loading-overlay { background:rgba(0,0,0,0.6); color:#eee; }
</style>
</head>
<body>
<div class="container">
<header>
  <img src="logo.png" alt="Logo Souza" class="logo-left">
  <div class="title-wrap">
    <h1>Souza Transportes</h1>
    <div id="appLegend" class="app-legend">ðŸš› Status da Frota â€” RegiÃ£o: ParÃ¡ & MaranhÃ£o</div>
  </div>
  <div style="text-align:right">
    <button id="refreshBtnTop" class="btn btn-success btn-icon" title="Atualizar">ðŸ”„</button>
    <button id="darkModeTop" class="btn btn-outline-dark btn-icon" title="Modo Escuro">ðŸŒ™</button>
  </div>
</header>

<div class="topbar">
  <button id="btnStatus" class="btn btn-outline-success nav-btn active" title="Status Frota">ðŸš›</button>
  <button id="btnProd" class="btn btn-outline-warning nav-btn" title="Produtividade">ðŸ“ˆ</button>
  <button id="btnVolume" class="btn btn-outline-primary nav-btn" title="Volume Entregue">ðŸ“Š</button>
  <button id="btnPneus" class="btn btn-outline-dark nav-btn" title="Pneus" onclick="window.open('https://pneus-souza.vercel.app/', '_blank')">
    <img src="logoPneu.png" alt="Pneu" width="24" height="24">
  </button>
</div>

<!-- STATUS -->
<div id="sectionStatus" class="section active">
  <div class="mb-2">
    <div style="font-weight:600; margin-bottom:6px;">Filtrar por Status, Produto e Destino:</div>
    <div class="d-flex gap-2 flex-wrap">
      <select id="filtroStatus" class="form-select form-select-sm" style="width:220px"><option value="">Todos os Status</option></select>
      <select id="filtroProduto" class="form-select form-select-sm" style="width:220px"><option value="">Todos os Produtos</option></select>
      <select id="filtroDestino" class="form-select form-select-sm" style="width:220px"><option value="">Todos os Destinos</option></select>
    </div>
  </div>

  <div id="resumoContainer" class="card card-kpi mb-2"><div id="resumoTexto">Carregando dados...</div></div>
  <div id="map"></div>
  <div id="frotaContainer" class="row g-3 mt-2"></div>
</div>

<!-- PRODUTIVIDADE -->
<div id="sectionProd" class="section">
  <div class="row g-3 mb-2">
    <div class="col-md-3"><div class="card card-kpi"><div class="kpi-label">Faturamento Total</div><div id="kpiFaturamento" class="kpi-value">--</div></div></div>
    <div class="col-md-3"><div class="card card-kpi"><div class="kpi-label">ComissÃ£o Total</div><div id="kpiComissao" class="kpi-value">--</div></div></div>
    <div class="col-md-3"><div class="card card-kpi"><div class="kpi-label">Peso Total (ton)</div><div id="kpiPesoTotal" class="kpi-value">--</div></div></div>
    <div class="col-md-3"><div class="card card-kpi"><div class="kpi-label">Viagens</div><div id="kpiViagens" class="kpi-value">--</div></div></div>
  </div>
  <div class="chart-card mb-2"><canvas id="chartProd"></canvas></div>
</div>

<!-- VOLUME -->
<div id="sectionVolume" class="section">
  <div class="chart-card mb-2"><canvas id="chartVolume"></canvas></div>
</div>

<div class="footer">Â© 2025 Souza Transportes</div>
<div class="loading-overlay" id="loadingOverlay">Carregando...</div>

<script>
const scriptURL = "https://script.google.com/macros/s/AKfycbxPxYiT6Hi_36xM1BnRY0Ww-kjFm6LUiShPb5PAE3WqSG8PYLAhdb-holArbkr1smcF/exec";
let map, markers = [], truckMarkers = [], caminhÃµes = [], marcadores = [];

document.addEventListener("DOMContentLoaded", async () => {
  initMap();
  await loadData();
  initButtons();
});

function initButtons(){
  document.getElementById("btnStatus").onclick = ()=>showSection("sectionStatus");
  document.getElementById("btnProd").onclick = ()=>showSection("sectionProd");
  document.getElementById("btnVolume").onclick = ()=>showSection("sectionVolume");
  document.getElementById("refreshBtnTop").onclick = async ()=>{ await loadData(); };
  document.getElementById("darkModeTop").onclick = ()=>document.body.classList.toggle("dark-mode");
}

function showSection(id){
  document.querySelectorAll(".section").forEach(s=>s.classList.remove("active"));
  document.getElementById(id).classList.add("active");
}

async function fetchJsonSafe(url){
  try{
    const res = await fetch(url);
    return await res.json();
  }catch(err){ console.error("Erro fetch:",err); return []; }
}

async function loadData(){
  document.getElementById("loadingOverlay").style.display="flex";
  const data = await fetchJsonSafe(scriptURL+'?t='+Date.now());
  caminhÃµes = data.caminhÃµes || [];
  marcadores = data.marcadores || [];

  updateResumo();
  updateFilters();
  renderFrota();
  renderMap();
  renderCharts();
  document.getElementById("loadingOverlay").style.display="none";
}

function initMap(){
  map = L.map('map').setView([-3.0, -52.0], 5);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{
    maxZoom:19,
    attribution:'&copy; OpenStreetMap contributors'
  }).addTo(map);

  // botÃ£o fullscreen custom
  L.Control.Fullscreen = L.Control.extend({
    onAdd: function(){ const btn=L.DomUtil.create('div','leaflet-control custom-fullscreen'); btn.innerHTML='<a href="#">â›¶</a>'; return btn; },
    onRemove: function(){}
  });
  map.addControl(new L.Control.Fullscreen({ position:'topleft' }));
}

function renderMap(){
  // limpa marcadores antigos
  markers.forEach(m=>map.removeLayer(m)); markers=[];
  truckMarkers.forEach(m=>map.removeLayer(m)); truckMarkers=[];

  // adiciona marcadores fixos
  marcadores.forEach(m=>{
    if(m.Latitude && m.Longitude){
      const mk = L.marker([parseFloat(m.Latitude), parseFloat(m.Longitude)])
        .addTo(map)
        .bindPopup(`<b>${m.Nome}</b><br>${m.Descricao||''}`);
      markers.push(mk);
    }
  });

  // adiciona caminhÃµes
  caminhÃµes.forEach(c=>{
    if(c.Latitude && c.Longitude){
      const mk = L.marker([parseFloat(c.Latitude), parseFloat(c.Longitude)],{
        icon:L.divIcon({className:'truck-label', html:`<span class="truck-emoji">ðŸš›</span>${c.Motorista||'--'}`})
      }).addTo(map);
      truckMarkers.push(mk);
    }
  });
}

function updateResumo(){
  const container = document.getElementById("resumoTexto");
  container.innerHTML = `CaminhÃµes: ${caminhÃµes.length} | Marcadores: ${marcadores.length}`;
}

function updateFilters(){
  const statusSet = new Set(caminhÃµes.map(c=>c.Status)), produtoSet=new Set(caminhÃµes.map(c=>c.Produto)), destinoSet=new Set(caminhÃµes.map(c=>c.Destino));
  const filtroStatus=document.getElementById("filtroStatus"), filtroProduto=document.getElementById("filtroProduto"), filtroDestino=document.getElementById("filtroDestino");
  filtroStatus.innerHTML='<option value="">Todos os Status</option>'; filtroProduto.innerHTML='<option value="">Todos os Produtos</option>'; filtroDestino.innerHTML='<option value="">Todos os Destinos</option>';
  statusSet.forEach(v=>filtroStatus.innerHTML+=`<option value="${v}">${v}</option>`);
  produtoSet.forEach(v=>filtroProduto.innerHTML+=`<option value="${v}">${v}</option>`);
  destinoSet.forEach(v=>filtroDestino.innerHTML+=`<option value="${v}">${v}</option>`);
  filtroStatus.onchange = renderFrota; filtroProduto.onchange=renderFrota; filtroDestino.onchange=renderFrota;
}

function renderFrota(){
  const container=document.getElementById("frotaContainer"); container.innerHTML='';
  const statusFilter=document.getElementById("filtroStatus").value;
  const produtoFilter=document.getElementById("filtroProduto").value;
  const destinoFilter=document.getElementById("filtroDestino").value;
  caminhÃµes.filter(c=>{
    return (!statusFilter||c.Status===statusFilter) &&
           (!produtoFilter||c.Produto===produtoFilter) &&
           (!destinoFilter||c.Destino===destinoFilter);
  }).forEach(c=>{
    const card=document.createElement("div"); card.className='col-md-3';
    card.innerHTML=`<div class="card card-kpi"><div class="kpi-label">${c.Motorista||'--'}</div><div class="kpi-value">${c.Status||'--'}</div></div>`;
    container.appendChild(card);
  });
}

function renderCharts(){
  // grÃ¡ficos simples de exemplo
  const prodCtx=document.getElementById("chartProd").getContext('2d');
  const prodLabels=caminhÃµes.map(c=>c.Motorista||'--'), prodData=caminhÃµes.map(c=>parseFloat(c.Faturamento)||0);
  if(window.prodChart) window.prodChart.destroy();
  window.prodChart=new Chart(prodCtx,{type:'bar',data:{labels:prodLabels,datasets:[{label:'Faturamento',data:prodData,backgroundColor:'rgba(46,125,50,0.7)'}]},options:{plugins:{datalabels:{anchor:'end',align:'top'}}}});

  const volCtx=document.getElementById("chartVolume").getContext('2d');
  const volLabels=caminhÃµes.map(c=>c.Produto||'--'), volData=caminhÃµes.map(c=>parseFloat(c.Quantidade)||0);
  if(window.volChart) window.volChart.destroy();
  window.volChart=new Chart(volCtx,{type:'bar',data:{labels:volLabels,datasets:[{label:'Volume',data:volData,backgroundColor:'rgba(0,123,255,0.7)'}]},options:{plugins:{datalabels:{anchor:'end',align:'top'}}}});
}
</script>
</div>
</body>
</html>
