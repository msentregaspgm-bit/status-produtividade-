<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Souza Transportes</title>

  <link rel="manifest" href="manifest.json" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet.fullscreen/Control.FullScreen.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://unpkg.com/leaflet.fullscreen/Control.FullScreen.js"></script>

  <style>
    body { background:#fff; font-family:"Segoe UI",sans-serif; padding:10px; transition:background .3s,color .3s; }
    body.dark-mode { background:#1c1c1c; color:#fff; }
    h1 { color:#2e7d32; font-weight:700; font-size:20px; margin:0; }
    .header { display:flex; align-items:center; justify-content:space-between; flex-wrap:wrap; margin-bottom:10px; }
    .logo { height:50px; width:auto; border-radius:8px; }
    .title-wrap { text-align:center; flex:1; }
    .legend { font-size:.9rem; color:#666; }
    .top-btns { display:flex; gap:6px; align-items:center; }
    #map { height:450px; border-radius:12px; margin:10px 0; }
    .card { border-radius:12px; box-shadow:0 2px 8px rgba(0,0,0,.08); }
    .status-carregado { color:#2e7d32; }
    .status-descarregando { color:#ff9800; }
    .status-parado { color:#d32f2f; }
    .truck-label { color:white; font-weight:600; text-shadow:0 0 4px rgba(0,0,0,.8); font-size:12px; white-space:nowrap; }
    .souza-toast { position:fixed; right:16px; bottom:20px; background:#2e7d32; color:#fff; padding:10px 14px; border-radius:8px; box-shadow:0 6px 18px rgba(0,0,0,.18); z-index:9999; }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <img src="logo.png" class="logo" alt="Souza Transportes" />
      <div class="title-wrap">
        <h1>Souza Transportes</h1>
        <div class="legend" id="pageLegend">üöõ Status da Frota</div>
      </div>
      <div class="top-btns">
        <button id="refreshBtn" class="btn btn-success btn-sm" title="Atualizar">üîÑ</button>
        <button id="clearCacheBtn" class="btn btn-outline-secondary btn-sm" title="Limpar Cache">üßπ</button>
        <button id="darkModeBtn" class="btn btn-outline-dark btn-sm" title="Modo Escuro">üåô</button>
      </div>
    </div>

    <div class="filter-bar d-flex flex-wrap gap-2 mb-2">
      <select id="filtroStatus" class="form-select form-select-sm"><option value="">Todos os Status</option></select>
      <select id="filtroProduto" class="form-select form-select-sm"><option value="">Todos os Produtos</option></select>
      <select id="filtroDestino" class="form-select form-select-sm"><option value="">Todos os Destinos</option></select>
    </div>

    <div id="resumoContainer" class="alert alert-light shadow-sm small">
      <strong>Resumo:</strong> <span id="resumoTexto" class="text-muted">Carregando...</span>
    </div>

    <div id="map"></div>

    <div id="frotaContainer" class="row g-3 mt-2"></div>

    <div class="footer text-center text-muted small mt-3">¬© 2025 Souza Transportes</div>
  </div>

  <script>
  const scriptURL = "https://script.google.com/macros/s/AKfycbyZDvHD4CCG4xAbuIjckNApANUkDow8uifF96C1R5DRKd4soQJVZKvNoWJ6hLDPyc5n/exec";
  let map, markers = [], dadosFrota = [];
  const geocodeCacheKey = "souza_geocode_cache_v2";

  function showToast(msg, err=false, t=3000){
    const div=document.createElement("div");
    div.className="souza-toast";
    div.style.background=err?"#d32f2f":"#2e7d32";
    div.innerText=msg;
    document.body.appendChild(div);
    setTimeout(()=>{div.style.opacity="0";setTimeout(()=>div.remove(),400)},t);
  }

  function limparCache(){
    localStorage.removeItem(geocodeCacheKey);
    showToast("Cache limpo ‚úÖ");
  }

  function aplicarDeslocamento(lat, lon){
    const off=0.02*(Math.random()-0.5);
    return [lat+off, lon+off];
  }

  async function geocodeCidade(cidade){
    if(!cidade) return null;
    const cache=JSON.parse(localStorage.getItem(geocodeCacheKey)||"{}");
    if(cache[cidade]) return cache[cidade];
    try{
      const r=await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(cidade+", Brasil")}`);
      const j=await r.json();
      if(j&&j[0]){
        const obj=[parseFloat(j[0].lat), parseFloat(j[0].lon)];
        cache[cidade]=obj;
        localStorage.setItem(geocodeCacheKey, JSON.stringify(cache));
        return obj;
      }
    }catch(e){console.warn("geocodeCidade",e);}
    return null;
  }

  async function atualizarMapa(dados){
    if(!map){
      map=L.map("map",{fullscreenControl:true}).setView([-15.78,-47.93],5);
      const hybrid=L.tileLayer("https://{s}.google.com/vt/lyrs=y,m&x={x}&y={y}&z={z}",{
        maxZoom:20,
        subdomains:["mt0","mt1","mt2","mt3"],
        attribution:"Map data ¬© Google Maps"
      }).addTo(map);
      const osm=L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",{attribution:"¬© OpenStreetMap"});
      L.control.layers({"üõ∞Ô∏è H√≠brido (Rodovias)":hybrid,"üó∫Ô∏è OpenStreetMap":osm}).addTo(map);
    }
    markers.forEach(m=>map.removeLayer(m)); markers=[];
    const group=[];
    for(const v of dados){
      const cidade=v["Posi√ß√£o"]||"";
      const frota=v.Frota||"";
      const status=(v.Status||"").toLowerCase();
      const color=status.includes("carregado")?"green":status.includes("descarregando")?"orange":"red";
      let pos=null;
      const lat=parseFloat(v.Latitude), lon=parseFloat(v.Longitude);
      if(!isNaN(lat)&&!isNaN(lon)) pos=aplicarDeslocamento(lat,lon);
      else { const g=await geocodeCidade(cidade); if(g) pos=aplicarDeslocamento(g[0],g[1]); }
      if(pos){
        const icon=L.divIcon({html:`<div style="font-size:22px;color:${color}">üöõ</div>`,iconSize:[24,24],iconAnchor:[12,12]});
        const marker=L.marker(pos,{icon}).addTo(map);
        marker.bindPopup(`<b>${frota}</b><br>${v.Status}<br>${v.Produto}<br>${cidade}<br><b>Destino:</b> ${v.Destino||"-"}`);
        const label=L.divIcon({className:"truck-label",html:frota,iconSize:[100,20],iconAnchor:[50,-15]});
        L.marker(pos,{icon:label}).addTo(map);
        markers.push(marker); group.push(marker);
      }
    }
    if(group.length){
      const gLayer=L.featureGroup(group);
      map.fitBounds(gLayer.getBounds(),{padding:[30,30]});
    }
  }

  function renderizarFrota(dados){
    const cont=document.getElementById("frotaContainer");
    const resumo=document.getElementById("resumoTexto");
    cont.innerHTML="";
    const total=dados.length;
    const c=dados.filter(v=>v.Status.toLowerCase().includes("carregado")).length;
    const d=dados.filter(v=>v.Status.toLowerCase().includes("descarregando")).length;
    const v=total-c-d;
    resumo.innerHTML=`Total: <b>${total}</b> | Carregados: <span class="text-success"><b>${c}</b></span> | Descarregando: <span class="text-warning"><b>${d}</b></span> | Vazios: <span class="text-danger"><b>${v}</b></span>`;
    dados.forEach(x=>{
      const st=(x.Status||"").toLowerCase();
      const stClass=st.includes("carregado")?"status-carregado":st.includes("descarregando")?"status-descarregando":"status-parado";
      cont.innerHTML+=`<div class="col-6 col-md-3"><div class="card p-2"><h6>${x.Frota||"-"}</h6><p class="${stClass}">${x.Status||"-"}</p><p><b>Produto:</b> ${x.Produto||"-"}</p><p><b>Posi√ß√£o:</b> ${x["Posi√ß√£o"]||"-"}</p><p><b>Destino:</b> ${x.Destino||"-"}</p><button class="btn btn-sm btn-outline-success mt-1" onclick="destacarCaminhao('${x.Frota}')">üìç Mapa</button></div></div>`;
    });
    atualizarMapa(dados);
  }

  function aplicarFiltros(){
    const fs=document.getElementById("filtroStatus").value.toLowerCase();
    const fp=document.getElementById("filtroProduto").value.toLowerCase();
    const fd=document.getElementById("filtroDestino").value.toLowerCase();
    const filtrados=dadosFrota.filter(v=>
      (!fs||v.Status.toLowerCase().includes(fs))&&
      (!fp||(v.Produto||"").toLowerCase().includes(fp))&&
      (!fd||(v.Destino||"").toLowerCase().includes(fd))
    );
    renderizarFrota(filtrados);
  }

  function preencherFiltros(dados){
    const s=new Set(), p=new Set(), d=new Set();
    dados.forEach(v=>{ s.add(v.Status); p.add(v.Produto); d.add(v.Destino); });
    const fill=(id,set)=>{ const el=document.getElementById(id); set.forEach(v=>{ if(v) el.innerHTML+=`<option value="${v}">${v}</option>`; }); };
    fill("filtroStatus",s); fill("filtroProduto",p); fill("filtroDestino",d);
  }

  async function buscarDados(){
    const cont=document.getElementById("frotaContainer");
    cont.innerHTML="<p class='text-center text-muted'>üîÑ Carregando...</p>";
    try{
      const resp=await fetch(scriptURL+"?t="+Date.now());
      const data=await resp.json();
      dadosFrota=data;
      preencherFiltros(data);
      renderizarFrota(data);
    }catch(e){
      cont.innerHTML="<p class='text-center text-danger'>Erro ao carregar.</p>";
      console.error(e);
    }
  }

  function destacarCaminhao(frota){
    const m=markers.find(m=>m.getPopup&&m.getPopup().getContent().includes(frota));
    if(m){ map.setView(m.getLatLng(),10); m.openPopup(); }
  }

  document.getElementById("refreshBtn").addEventListener("click",buscarDados);
  document.getElementById("clearCacheBtn").addEventListener("click",limparCache);
  document.getElementById("darkModeBtn").addEventListener("click",()=>document.body.classList.toggle("dark-mode"));
  document.querySelectorAll(".filter-bar select").forEach(s=>s.addEventListener("change",aplicarFiltros));
  window.onload=()=>{ buscarDados(); };
  </script>
</body>
</html>
